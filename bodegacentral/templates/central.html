{% extends 'base.html'%}

{% block content %}

<br>

<!-- BUSCADOR -->
<input id="searchInput" type="text" class="form-control mb-3" placeholder="Buscar...">

<div class="table-scroll">
  <table id="dataTable" class="table table-striped table-hover table-bordered">
    <thead>
      <tr>
        <th>Categoria</th>
        <th>Empresa</th>
        <th>Ubicacion</th>
        <th>Cod_Ean</th>
        <th>Cod_Dun</th>
        <th>Cod_Sistema</th>
        <th>Descripcion</th>
        <th>Unidad</th>
        <th>Pack</th>
        <th>FactorX</th>
        <th>Cajas</th>
        <th>Saldo</th>
        <th>Stock_Fisico</th>
        <th>Observacion</th>
        <th>Fecha_Venc</th>
        <th>Fecha_Imp</th>
        <th>Contenedor</th>
        <th>Fecha_Inv</th>
        <th>Encargado</th>

        <!-- ðŸ”µ NUEVAS COLUMNAS -->
        <th>Editar</th>
        <th>Eliminar</th>
      </tr>
    </thead>

    <tbody>
      {% for central in centrales %}
      <tr>
        <td>{{ central.categoria }}</td>
        <td>{{ central.empresa }}</td>
        <td>{{ central.ubicacion }}</td>
        <td>{{ central.cod_ean }}</td>
        <td>{{ central.cod_dun }}</td>
        <td>{{ central.cod_sistema }}</td>
        <td>{{ central.descripcion }}</td>
        <td>{{ central.unidad }}</td>
        <td>{{ central.pack }}</td>
        <td>{{ central.factorx }}</td>
        <td>{{ central.cajas }}</td>
        <td>{{ central.saldo }}</td>
        <td>{{ central.stock_fisico }}</td>
        <td>{{ central.observacion }}</td>
        <td>{{ central.fecha_venc }}</td>
        <td>{{ central.fecha_imp }}</td>
        <td>{{ central.contenedor }}</td>
        <td>{{ central.fecha_inv }}</td>
        <td>{{ central.encargado }}</td>

        <!-- ðŸ”µ COLUMNA EDITAR -->
        <td>
          <a href="{% url 'editar_central' central.id %}" class="btn btn-warning btn-sm">Editar</a>
        </td>

        <!-- ðŸ”´ COLUMNA ELIMINAR -->
        <td>
          <a href="{% url 'eliminar_central' central.id %}"
             class="btn btn-danger btn-sm"
             onclick="return confirm('Â¿Seguro que deseas eliminar este registro?')">
             Eliminar
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>

  </table>
</div>

<!-- PAGINACIÃ“N FUERA DE LA TABLA -->
<div id="pagination" class="mt-3 d-flex gap-2 justify-content-center"></div>

<script>
// =======================
// CONFIGURACIÃ“N
// =======================
const rowsPerPage = 10;
let currentPage = 1;

// =======================
// ELEMENTOS
// =======================
const searchInput = document.getElementById("searchInput");
const table = document.getElementById("dataTable");
const rows = Array.from(table.getElementsByTagName("tbody")[0].rows);
const paginationContainer = document.getElementById("pagination");

// =======================
// FILTRAR FILAS
// =======================
function filterRows() {
    const text = searchInput.value.toLowerCase();
    const filtered = rows.filter(row =>
        row.innerText.toLowerCase().includes(text)
    );

    currentPage = 1;
    displayPage(filtered);
    setupPagination(filtered);
}

// =======================
// MOSTRAR FILAS DE LA PÃGINA
// =======================
function displayPage(filteredRows) {
    rows.forEach(row => row.style.display = "none");

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filteredRows.slice(start, end).forEach(row => {
        row.style.display = "";
    });
}

// =======================
// PAGINACIÃ“N
// =======================
function setupPagination(filteredRows) {
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);

    paginationContainer.innerHTML = `
        <button class="btn btn-primary btn-sm" id="prevBtn" ${currentPage===1?'disabled':''}>Anterior</button>
        <span class="p-2">PÃ¡gina ${currentPage} de ${totalPages}</span>
        <button class="btn btn-primary btn-sm" id="nextBtn" ${currentPage===totalPages?'disabled':''}>Siguiente</button>
    `;

    document.getElementById("prevBtn").onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            displayPage(filteredRows);
            setupPagination(filteredRows);
        }
    };

    document.getElementById("nextBtn").onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            displayPage(filteredRows);
            setupPagination(filteredRows);
        }
    };
}

// =======================
// EVENTO DE BÃšSQUEDA
// =======================
searchInput.addEventListener("keyup", filterRows);

// =======================
// MOSTRAR TODO AL INICIO
// =======================
displayPage(rows);
setupPagination(rows);
</script>

{% endblock %}
