{% extends 'base.html'%}

{% block content %}

<div style="text-align: left;">
    <a href="{% url 'inicio' %}" class="btn-volver">â¬… Volver</a>
</div>

<br>

<!-- BUSCADOR -->
<div class="row mb-3">
    <div class="col-md-4">
        <input id="searchInput" type="text" class="form-control"
               placeholder="ðŸ” Buscar en toda la tabla...">
    </div>

    <div class="col-md-4">
        <select id="pedidoFilter" class="form-select">
            <option value="">ðŸ“¦ Todos los pedidos</option>
        </select>
    </div>

    <div class="col-md-4 d-grid">
        <button id="clearFilters" class="btn btn-secondary">
            ðŸ§¹ Limpiar filtros
        </button>
    </div>
</div>





<!-- Tabla -->
<div class="table-scroll">
    <table id="dataTable" class="table table-striped table-hover table-bordered">

        <thead>
            <tr>
                <th>Categoria</th>
                <th>Empresa</th>
                <th>Cant_Solicitada</th>
                <th>Pedido</th>
                <th>Ubicacion</th>
                <th>Cod_Ean</th>
                <th>Cod_Dun</th>
                <th>Cod_Sistema</th>
                <th>Descripcion</th>
                <th>Unidad</th>
                <th>Pack</th>
                <th>FactorX</th>
                <th>Cajas</th>
                <th>Saldo</th>
                <th>Stock_Fisico</th>
                <th>Observacion</th>
                <th>Fecha_Venc</th>
                <th>Fecha_Imp</th>
                <th>Contenedor</th>
                <th>Fecha_Inv</th>
                <th>Encargado</th>

                <!-- ðŸ”µ NUEVAS COLUMNAS -->
                <th>Editar</th>
                <th>Eliminar</th>
            </tr>
        </thead>

        <tbody>
            {% for bsfs in bsfs %}
            <tr>
                <td>{{ bsfs.categoria }}</td>
                <td>{{ bsfs.empresa }}</td>
                <td>{{ bsfs.cant_solicitada }}</td>
                <td>{{ bsfs.pedido }}</td>
                <td>{{ bsfs.ubicacion }}</td>
                <td>{{ bsfs.cod_ean }}</td>
                <td>{{ bsfs.cod_dun }}</td>
                <td>{{ bsfs.cod_sistema }}</td>
                <td>{{ bsfs.descripcion }}</td>
                <td>{{ bsfs.unidad }}</td>
                <td>{{ bsfs.pack }}</td>
                <td>{{ bsfs.factorx }}</td>
                <td>{{ bsfs.cajas }}</td>
                <td>{{ bsfs.saldo }}</td>
                <td>{{ bsfs.stock_fisico }}</td>
                <td>{{ bsfs.observacion }}</td>
                <td>{{ bsfs.fecha_venc }}</td>
                <td>{{ bsfs.fecha_imp }}</td>
                <td>{{ bsfs.contenedor }}</td>
                <td>{{ bsfs.fecha_inv }}</td>
                <td>{{ bsfs.encargado }}</td>

                <!-- ðŸ”µ NUEVA COLUMNA: EDITAR -->
                <td>
                    <a href="{% url 'editar_bsf' bsfs.id %}" class="btn btn-warning btn-sm">Editar</a>
                </td>

                <!-- ðŸ”´ NUEVA COLUMNA: ELIMINAR -->
                <td>
                    <a href="{% url 'eliminar_bsf' bsfs.id %}" 
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Â¿Seguro que deseas eliminar este registro?')">
                       Eliminar
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>

    </table>
</div>

<!-- PAGINACIÃ“N FUERA DE LA TABLA -->
<div id="pagination" class="mt-3 d-flex gap-2 justify-content-center"></div>

<script>
const rowsPerPage = 10;
let currentPage = 1;

const searchInput = document.getElementById("searchInput");
const pedidoFilter = document.getElementById("pedidoFilter");
const clearBtn = document.getElementById("clearFilters");
const table = document.getElementById("dataTable");
const rows = Array.from(table.tBodies[0].rows);
const paginationContainer = document.getElementById("pagination");

// =======================
// CARGAR PEDIDOS ÃšNICOS
// =======================
function cargarPedidos() {
    const pedidos = new Set();

    rows.forEach(row => {
        const pedido = row.cells[3].innerText.trim();
        if (pedido) pedidos.add(pedido);
    });

    [...pedidos].sort().forEach(pedido => {
        const option = document.createElement("option");
        option.value = pedido.toLowerCase();
        option.textContent = pedido;
        pedidoFilter.appendChild(option);
    });
}

// =======================
// FILTRO COMBINADO
// =======================
function filterRows() {
    const texto = searchInput.value.toLowerCase();
    const pedidoSeleccionado = pedidoFilter.value;

    const filtered = rows.filter(row => {
        const textoFila = row.innerText.toLowerCase();
        const pedidoFila = row.cells[3].innerText.toLowerCase();

        return textoFila.includes(texto) &&
               (pedidoSeleccionado === "" || pedidoFila === pedidoSeleccionado);
    });

    currentPage = 1;
    displayPage(filtered);
    setupPagination(filtered);
}

// =======================
// LIMPIAR FILTROS
// =======================
function limpiarFiltros() {
    searchInput.value = "";
    pedidoFilter.value = "";
    currentPage = 1;

    displayPage(rows);
    setupPagination(rows);
}

// =======================
// MOSTRAR FILAS
// =======================
function displayPage(filteredRows) {
    rows.forEach(row => row.style.display = "none");

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filteredRows.slice(start, end).forEach(row => {
        row.style.display = "";
    });
}

// =======================
// PAGINACIÃ“N
// =======================
function setupPagination(filteredRows) {
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;

    paginationContainer.innerHTML = `
        <button class="btn btn-primary btn-sm" id="prevBtn" ${currentPage===1?'disabled':''}>Anterior</button>
        <span class="p-2">PÃ¡gina ${currentPage} de ${totalPages}</span>
        <button class="btn btn-primary btn-sm" id="nextBtn" ${currentPage===totalPages?'disabled':''}>Siguiente</button>
    `;

    document.getElementById("prevBtn").onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            displayPage(filteredRows);
            setupPagination(filteredRows);
        }
    };

    document.getElementById("nextBtn").onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            displayPage(filteredRows);
            setupPagination(filteredRows);
        }
    };
}

// =======================
// EVENTOS
// =======================
searchInput.addEventListener("keyup", filterRows);
pedidoFilter.addEventListener("change", filterRows);
clearBtn.addEventListener("click", limpiarFiltros);

// =======================
// INICIO
// =======================
cargarPedidos();
displayPage(rows);
setupPagination(rows);
</script>


{% endblock %}
